create database tour;
use tour;


CREATE TABLE PLACES(
PLACE_ID VARCHAR(10) PRIMARY KEY,
PLACE_NAME VARCHAR(35) NOT NULL
);


insert into places(place_id,place_name) values('Mur301','Murree');
insert into places(place_id,place_name) values('Isl401','Islamabad');
insert into places(place_id,place_name) values('Lah501','Lahore');
insert into places(place_id,place_name) values('Peh601','Peshawar');


CREATE TABLE TRANSPORT(
TRANS_ID VARCHAR(10) PRIMARY KEY,
TRANS_TYPE VARCHAR(20) NOT NULL,
TRANS_FARE NUMERIC
);

insert into TRANSPORT(TRANS_id,TRANS_type,TRANS_fare) values('C101','Car',30000);
insert into TRANSPORT(TRANS_id,TRANS_type,TRANS_fare) values('F102','Flight',40000);
insert into TRANSPORT(TRANS_id,TRANS_type,TRANS_fare) values('B102','Bus',20000);


CREATE TABLE HOTELS(
HOTEL_ID VARCHAR(10) PRIMARY KEY,
HOTEL_NAME VARCHAR(20) NOT NULL,
HOTEL_FARE NUMERIC,
HOTEL_CONTACT_NO VARCHAR(12) NOT NULL,
PLACE_ID VARCHAR(10),
CONSTRAINT FK_PLACES_hotel FOREIGN KEY(Place_ID) REFERENCES places(Place_ID)
);

insert into Hotels(HOTEL_ID,HOTEL_NAME,HOTEL_FARE,HOTEL_CONTACT_NO,PLACE_ID) values("HGR101","Hotel Grand Area",15000,'0303-3456423',"Isl401");
insert into Hotels(HOTEL_ID,HOTEL_NAME,HOTEL_FARE,HOTEL_CONTACT_NO,PLACE_ID) values("OGR201","Oriole Guest House",20000,'0311-0325813',"Isl401");

insert into Hotels(HOTEL_ID,HOTEL_NAME,HOTEL_FARE,HOTEL_CONTACT_NO,PLACE_ID) values("GPH301","Grand Palm Hotel",10000,'0361-0245814',"Lah501");
insert into Hotels(HOTEL_ID,HOTEL_NAME,HOTEL_FARE,HOTEL_CONTACT_NO,PLACE_ID) values("LGH401","Luxus Grand Hotel",25000,'0300-0345098',"Lah501");

insert into Hotels(HOTEL_ID,HOTEL_NAME,HOTEL_FARE,HOTEL_CONTACT_NO,PLACE_ID) values("GTH501","Grand Taj Hotel",10000,'0300-0345098',"Mur301");
insert into Hotels(HOTEL_ID,HOTEL_NAME,HOTEL_FARE,HOTEL_CONTACT_NO,PLACE_ID) values("HM601","Hotel Mehran",25000,'0300-0345098',"Mur301");

insert into Hotels(HOTEL_ID,HOTEL_NAME,HOTEL_FARE,HOTEL_CONTACT_NO,PLACE_ID) values("SR701","Shelton's Rezidor",25000,'0300-0345098',"Peh601");
insert into Hotels(HOTEL_ID,HOTEL_NAME,HOTEL_FARE,HOTEL_CONTACT_NO,PLACE_ID) values("PCH801","PEARL CITY HOTEL",35000,'0300-0345098',"Peh601");


CREATE TABLE USERS(
USER_ID INT AUTO_INCREMENT primary key,
USER_FNAME VARCHAR(15) NOT NULL,
USER_LNAME VARCHAR(15) NOT NULL,
USER_PASSWORD VARCHAR(10) NOT NULL,
DOB DATE,
USER_ADDRESS VARCHAR(35),
USER_EMAIL VARCHAR(35) unique NOT NULL,
USER_CONTACT_NO VARCHAR(12),
PLACE_ID VARCHAR(10),
TRANS_ID VARCHAR(10),
HOTEL_ID VARCHAR(10),
CONSTRAINT FK_PLACES_USERS FOREIGN KEY(Place_ID) REFERENCES places(Place_ID),
CONSTRAINT FK_Trans_USERS FOREIGN KEY(Trans_ID) REFERENCES transport(Trans_ID),
CONSTRAINT FK_Hotel_USERS FOREIGN KEY(Hotel_ID) REFERENCES  Hotels(Hotel_ID)
);


CREATE TABLE TOUR_DETAILS(
FROM_DATE DATE ,
TO_DATE DATE NOT NULL,
USER_ID INT,
INDEX (USER_ID),
CONSTRAINT PK_TOUR_DETAILS PRIMARY KEY(USER_ID, FROM_DATE),
CONSTRAINT FK_TOUR_DETAILS_USERS FOREIGN KEY(USER_ID) REFERENCES USERS(USER_ID) on delete cascade);


CREATE TABLE PAYMENT(
PAY_ID INT AUTO_INCREMENT  PRIMARY KEY,
HOTEL_AMOUNT NUMERIC,
TRANS_AMOUNT NUMERIC,
TOTAL_BILL NUMERIC DEFAULT 00.00 NULL,
USER_ID INT,
INDEX (USER_ID),
CONSTRAINT FK_PAYMENT_USERS FOREIGN KEY(USER_ID) REFERENCES USERS(USER_ID)
on delete cascade);

DELIMITER $
CREATE PROCEDURE INSERT_FARE_IN(IN UID INT)
BEGIN
    DECLARE HO_FARE NUMERIC(10,2);
    DECLARE TR_FARE NUMERIC(10,2);
    DECLARE TOTAL NUMERIC(10,2);
    SELECT HOTEL_FARE INTO HO_FARE FROM HOTELS WHERE HOTEL_ID = (SELECT HOTEL_ID FROM USERS WHERE USER_ID=UID);
    SELECT TRANS_FARE INTO TR_FARE FROM TRANSPORT WHERE TRANS_ID = (SELECT TRANS_ID FROM USERS WHERE USER_ID=UID);
    SET TOTAL = HO_FARE + TR_FARE;
    INSERT INTO PAYMENT (HOTEL_AMOUNT, TRANS_AMOUNT, TOTAL_BILL, USER_ID)
    VALUES (HO_FARE, TR_FARE, TOTAL, UID);
END $
DELIMITER ;


